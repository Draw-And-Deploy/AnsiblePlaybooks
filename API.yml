---
- hosts: APIServer
  become: yes
  tasks:
  - name: Make api folder
    file:
      path: /api
      state: directory

  - name: Installing packages
    package:
      name: "{{ item }}"
      state: latest
    with_items:
    - python3-pip
    - python3-virtualenv
    - git

  - name: Git clone repository
    git:
      repo: https://github.com/draw-and-deploy/api
      dest: /api
      clone: yes
      update: yes

  - name: Installing pip packages
    pip:
      name: "{{ item }}"
      state: present
      virtualenv: /api/venv
    with_items:
    - fastapi
    - uvicorn
    - gunicorn

  - name: Creating error files
    file:
      path: "{{ item }}"
      state: touch
      mode: "0733"
    with_items:
    - "/api/access_log"
    - "/api/error_log"

  - name: Creating gunicorn config file
    copy:
      src: /playbooks/Config/gunicorn_config.py
      dest: /api/gunicorn_config.py
      mode: 0644

  - name: Creating systemd file
    copy:
      src: /playbooks/Config/api_dnd.service
      dest: /etc/systemd/system/api_dnd.service        
      mode: 0644
  
  - name: Restart the service 
    services:
      name: api_dnd
      state: restarted
      enabled: yes
